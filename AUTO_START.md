# Автоматический запуск ботов при старте приложения

## Описание

Добавлена поддержка автоматического запуска Telegram-ботов при старте приложения через переменные окружения. Логика автозапуска находится в `__main__.py` и выполняется перед запуском Flask-сервера, что гарантирует правильный порядок инициализации.

Автозапуск **не влияет** на ручное управление ботами через веб-панель:
- Кнопки `/start-bot`, `/start-support-bot`, `/start-both-bots` в панели работают как прежде
- Защита от двойного запуска реализована на уровне проверок статуса (`_is_main_bot_running()`, `_is_support_bot_running()`)
- Автозапуск проверяет наличие обязательных настроек перед запуском каждого бота

---

## Использование

### Способ 1: Использование `SHOPBOT_AUTO_START` (рекомендуется)

Установите одну переменную окружения с указанием, какие боты запускать:

**Запустить оба бота:**
```bash
export SHOPBOT_AUTO_START=1
# или
export SHOPBOT_AUTO_START=true
export SHOPBOT_AUTO_START=both
export SHOPBOT_AUTO_START=all
```

**Запустить только основной Telegram-бот:**
```bash
export SHOPBOT_AUTO_START=main
# или
export SHOPBOT_AUTO_START=bot
```

**Запустить только Support-бот:**
```bash
export SHOPBOT_AUTO_START=support
# или
export SHOPBOT_AUTO_START=support_bot
```

**Отключить автозапуск:**
```bash
export SHOPBOT_AUTO_START=0
# или просто не устанавливать переменную
```

### Способ 2: Отдельные флаги для каждого бота

Если нужна более гибкая конфигурация, используйте отдельные переменные:

```bash
# Запустить только основной бот
export SHOPBOT_AUTO_START_MAIN=1

# Запустить только support-бот
export SHOPBOT_AUTO_START_SUPPORT=1

# Запустить оба
export SHOPBOT_AUTO_START_MAIN=1
export SHOPBOT_AUTO_START_SUPPORT=1
```

---

## Docker Compose

### Пример конфигурации docker-compose.yml

```yaml
services:
  3xui-shopbot:
    build: .
    restart: unless-stopped
    ports:
      - '1488:1488'
    volumes:
      - .:/app/project
    container_name: 3xui-shopbot-ssl-disabled
    environment:
      # Автозапуск обоих ботов при старте контейнера
      SHOPBOT_AUTO_START: "1"
```

### Примеры различных конфигураций

**Запустить оба бота:**
```yaml
environment:
  SHOPBOT_AUTO_START: "both"
```

**Запустить только основной бот:**
```yaml
environment:
  SHOPBOT_AUTO_START: "main"
```

**Запустить только support-бот:**
```yaml
environment:
  SHOPBOT_AUTO_START: "support"
```

**Использовать отдельные флаги:**
```yaml
environment:
  SHOPBOT_AUTO_START_MAIN: "1"
  SHOPBOT_AUTO_START_SUPPORT: "1"
```

---

## Логика работы

### Порядок инициализации

1. **Инициализация БД** → создаются таблицы и настройки
2. **Создание контроллеров** → `BotController`, `SupportBotController`
3. **Инициализация Flask** → приложение готово к обработке запросов
4. **Проверка автозапуска** → чтение переменных окружения и настроек из БД
5. **Запуск бота(ов)** (если требуется) → асинхронная инициализация
6. **Запуск Flask-сервера** → веб-панель готова к использованию

### Проверка конфигурации

Перед автозапуском каждого бота система проверяет наличие обязательных параметров:

**Основной Telegram-бот требует:**
- `telegram_bot_token` — токен бота от BotFather
- `telegram_bot_username` — username бота (без @)
- `admin_telegram_id` — ID администратора

**Support-бот требует:**
- `support_bot_token` — токен support-бота
- `support_bot_username` — username support-бота
- `admin_telegram_id` — ID администратора

Если любой из параметров отсутствует, соответствующий бот не будет запущен автоматически, и в логах появится сообщение с указанием причины.

### Защита от двойного запуска

Функции `_is_main_bot_running()` и `_is_support_bot_running()` проверяют текущий статус перед запуском:
- Если бот уже работает → попытка запуска игнорируется
- Ручные команды через веб-панель проходят ту же проверку
- Результат отправляется пользователю с понятным сообщением

---

## Логирование

При автозапуске в консоль выводятся информационные сообщения:

```
[HH:MM:SS] [INFO] Обнаружены переменные автоматического запуска. Проверяю конфигурацию ботов...
[HH:MM:SS] [INFO] Автоматический запуск основного Telegram-бота...
[HH:MM:SS] [INFO] ✓ Основной бот запущен: Команда на запуск бота отправлена.
[HH:MM:SS] [INFO] Автоматический запуск Support-бота...
[HH:MM:SS] [INFO] ✓ Support-бот запущен: Команда на запуск бота отправлена.
```

Если какой-то параметр не заполнен:

```
[HH:MM:SS] [INFO] Основной бот не будет запущен: не все необходимые параметры заполнены (telegram_bot_token, telegram_bot_username, admin_telegram_id)
```

---

## Важные замечания

1. **Условие запуска:** Автозапуск выполняется **только** при наличии хотя бы одной переменной окружения (`SHOPBOT_AUTO_START`, `SHOPBOT_AUTO_START_MAIN` или `SHOPBOT_AUTO_START_SUPPORT`)

2. **Нет конфликта с ручным управлением:** Если бот уже был запущен автоматически, ручные команды из веб-панели работают корректно

3. **Flask-сервер стартует в любом случае:** Независимо от статуса ботов, веб-панель становится доступна на порту 1488 (по умолчанию)

4. **Проверка конфигурации:** Перед запуском каждый бот проверяет наличие обязательных настроек в БД. Если они не заполнены, бот не стартует

5. **Приоритет переменных:** Если установлены обе группы переменных (`SHOPBOT_AUTO_START` и `SHOPBOT_AUTO_START_*`), приоритет имеет `SHOPBOT_AUTO_START`

---

## Примеры реальных сценариев

### Сценарий 1: Запуск основного бота при старте Docker

**docker-compose.yml:**
```yaml
environment:
  SHOPBOT_AUTO_START: "main"
```

**Результат:**
- При старте контейнера основной бот загружается автоматически
- Support-бот можно запустить вручную из веб-панели

### Сценарий 2: Запуск обоих ботов в production

**docker-compose.yml:**
```yaml
environment:
  SHOPBOT_AUTO_START: "1"
```

**Результат:**
- При старте контейнера оба бота загружаются автоматически
- Веб-панель готова к управлению и мониторингу

### Сценарий 3: Разработка с одним ботом

**Запуск локально:**
```bash
export SHOPBOT_AUTO_START=main
python -m shop_bot
```

**Результат:**
- Основной бот начинает обработку обновлений сразу
- Разработчик может начать тестирование без дополнительных кликов

### Сценарий 4: Отключение автозапуска

**docker-compose.yml:**
```yaml
# SHOPBOT_AUTO_START не задана
```

**Результат:**
- Приложение запускается в режиме ручного управления
- Боты можно запустить только из веб-панели
